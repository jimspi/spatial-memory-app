<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Spatial Memory</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- iOS PWA support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SpatialMem">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNTIgMTUyIj4KICA8cmVjdCB3aWR0aD0iMTUyIiBoZWlnaHQ9IjE1MiIgZmlsbD0iIzAwMDAwMCIvPgogIDxjaXJjbGUgY3g9Ijc2IiBjeT0iNzYiIHI9IjIyIiBmaWxsPSIjM0I4MkY2Ii8+CiAgPGNpcmNsZSBjeD0iNzYiIGN5PSIxMjQiIHI9IjEwIiBmaWxsPSIjM0I4MkY2Ii8+Cjwvc3ZnPg==">
    
    <!-- Theme colors -->
    <meta name="theme-color" content="#3B82F6">
    <meta name="msapplication-navbutton-color" content="#3B82F6">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        
        .app-container {
            max-width: 100vw;
            min-height: 100vh;
            position: relative;
        }
        
        .status-bar {
            background: #1a1a1a;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .status-active {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .pulse-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .current-location {
            background: #2a2a2a;
            padding: 16px 20px;
            border-bottom: 1px solid #404040;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .current-location:active {
            background: #333;
        }
        
        .location-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .location-icon {
            color: #3b82f6;
            font-size: 18px;
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }
        
        .location-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        .location-accuracy {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }
        
        .refresh-btn {
            background: none;
            border: none;
            color: #3b82f6;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .refresh-btn:active {
            transform: scale(0.9);
            background: #374151;
        }
        
        .tabs {
            display: flex;
            background: #1a1a1a;
            border-bottom: 1px solid #404040;
        }
        
        .tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            background: none;
            border: none;
            color: #888;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .tab-content {
            padding: 20px;
            min-height: 60vh;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .action-btn {
            background: #3b82f6;
            border: none;
            border-radius: 12px;
            padding: 16px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 60px;
        }
        
        .action-btn:active {
            transform: scale(0.95);
            background: #2563eb;
        }
        
        .action-btn.secondary {
            background: #374151;
        }
        
        .action-btn.secondary:active {
            background: #4b5563;
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .section-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .memory-card {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #3b82f6;
            position: relative;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .memory-card:active {
            transform: scale(0.98);
            background: #333;
        }
        
        .memory-item {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .memory-location {
            font-size: 14px;
            color: #888;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .memory-time {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .confidence-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #22c55e;
            color: #000;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .confidence-badge.medium {
            background: #eab308;
        }
        
        .confidence-badge.low {
            background: #ef4444;
            color: white;
        }
        
        .floating-camera {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #3b82f6;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .floating-camera:active {
            transform: scale(0.9);
        }
        
        .floating-camera:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .notification-prompt {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            margin: 20px;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #3b82f6;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .prompt-text {
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        
        .prompt-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .prompt-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .prompt-btn.primary {
            background: #3b82f6;
            color: white;
        }
        
        .prompt-btn.secondary {
            background: #374151;
            color: white;
        }
        
        .prompt-btn:active {
            transform: scale(0.95);
        }
        
        .camera-preview {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 2000;
            display: none;
            flex-direction: column;
        }
        
        .camera-preview.active {
            display: flex;
        }
        
        .camera-header {
            padding: 20px;
            text-align: center;
            background: rgba(0,0,0,0.9);
            border-bottom: 1px solid #333;
        }
        
        .camera-view {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        #cameraVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .camera-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 18px;
            text-align: center;
            line-height: 1.6;
            height: 100%;
        }
        
        .camera-controls {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.9);
            border-top: 1px solid #333;
        }
        
        .capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #fff;
            border: 4px solid #ccc;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .capture-btn:active {
            transform: scale(0.9);
            background: #f0f0f0;
        }
        
        .capture-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .camera-close {
            background: #374151;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .camera-close:active {
            background: #4b5563;
        }
        
        .processing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .processing-overlay.active {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .processing-text {
            color: #888;
            font-size: 16px;
            text-align: center;
        }
        
        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .location-item {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .location-item:active {
            background: #333;
        }
        
        .location-details h3 {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .location-details p {
            font-size: 14px;
            color: #888;
        }
        
        .location-stats {
            text-align: right;
            font-size: 12px;
            color: #666;
        }
        
        .location-visits {
            font-weight: 600;
            color: #3b82f6;
        }
        
        .setting-item {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .setting-info h3 {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .setting-info p {
            font-size: 14px;
            color: #888;
        }
        
        .toggle {
            position: relative;
            width: 50px;
            height: 24px;
            background: #374151;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .toggle.active {
            background: #3b82f6;
        }
        
        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .toggle.active::after {
            transform: translateX(26px);
        }
        
        .toast {
            position: fixed;
            bottom: 100px;
            left: 20px;
            right: 20px;
            background: #22c55e;
            color: #000;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            transform: translateY(100px);
            transition: all 0.3s;
            z-index: 1500;
        }
        
        .toast.show {
            transform: translateY(0);
        }
        
        .toast.error {
            background: #ef4444;
            color: white;
        }
        
        .search-bar {
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 16px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .search-bar::placeholder {
            color: #666;
        }
        
        .search-bar:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .install-banner {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            margin: 20px;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            animation: slideIn 0.3s ease-out;
        }
        
        .install-text {
            font-size: 14px;
            margin-bottom: 12px;
        }
        
        .install-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .install-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .install-btn.primary {
            background: white;
            color: #3b82f6;
        }
        
        .install-btn.secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .install-btn:active {
            transform: scale(0.95);
        }
        
        .memory-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 12px;
            border: 1px solid #404040;
        }
        
        .memory-content {
            flex: 1;
        }
        
        .ai-detected {
            font-size: 10px;
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }
        
        .offline-indicator {
            background: #ef4444;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            margin-left: 8px;
        }
        
        .sync-status {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-active">
                <div class="pulse-dot"></div>
                <span>Spatial Memory Active</span>
                <span id="offlineIndicator" class="offline-indicator" style="display: none;">Offline</span>
            </div>
            <div>
                <span id="statusTime">--:--</span>
                <span style="margin-left: 8px;">üîã üì∂</span>
            </div>
        </div>
        
        <!-- Current Location -->
        <div class="current-location" onclick="refreshLocation()">
            <div class="location-info">
                <div class="location-icon">üìç</div>
                <div class="location-text">
                    <div class="location-label">Current Location</div>
                    <div class="location-name" id="currentLocation">Detecting location...</div>
                    <div class="location-accuracy" id="locationAccuracy">Tap to refresh</div>
                </div>
                <button class="refresh-btn" id="refreshLocationBtn">üîÑ</button>
            </div>
        </div>
        
        <!-- Install Banner -->
        <div class="install-banner" id="installBanner" style="display: none;">
            <div class="install-text">
                üì± Install AI Spatial Memory for the best experience!
            </div>
            <div class="install-actions">
                <button class="install-btn secondary" onclick="dismissInstall()">Later</button>
                <button class="install-btn primary" onclick="installApp()">Install</button>
            </div>
        </div>
        
        <!-- Smart Notification -->
        <div class="notification-prompt" id="smartPrompt" style="display: none;">
            <div class="prompt-text" id="promptText">
                You'll pass the hardware store in 15 mins - need those batteries you mentioned?
            </div>
            <div class="prompt-actions">
                <button class="prompt-btn secondary" onclick="dismissPrompt()">Later</button>
                <button class="prompt-btn primary" onclick="addToList()">Add to List</button>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('memories')">üì± Memories</button>
            <button class="tab" onclick="showTab('locations')">üìç Places</button>
            <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
        </div>
        
        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Memories Tab -->
            <div class="tab-panel active" id="memories">
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="action-btn" id="quickTagBtn" onclick="quickTag()">
                        üì∑ Quick Tag
                    </button>
                    <button class="action-btn secondary" onclick="findItem()">
                        üîç Find Item
                    </button>
                </div>
                
                <!-- Search -->
                <input type="text" class="search-bar" placeholder="Search your memories..." id="memorySearch" oninput="searchMemories()">
                
                <!-- Recent Memories -->
                <div class="section-header">
                    Recent Memories
                    <span id="memoryCount">0</span>
                </div>
                
                <div id="memoriesList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üß†</div>
                        <p>No memories yet</p>
                        <p style="font-size: 14px; color: #888; margin-top: 8px;">
                            Tap the camera button to start tagging items
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Locations Tab -->
            <div class="tab-panel" id="locations">
                <div class="section-header">Frequent Locations</div>
                <div id="locationsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìç</div>
                        <p>No locations tracked yet</p>
                        <p style="font-size: 14px; color: #888; margin-top: 8px;">
                            Locations will appear as you use the app
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div class="tab-panel" id="settings">
                <div class="section-header">Privacy & Settings</div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>üîí Local Storage Only</h3>
                        <p>All data stays on your device</p>
                    </div>
                    <div class="toggle active" onclick="toggleSetting(this, 'localStorage')"></div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>üì± Auto-detect Items</h3>
                        <p>Use AI to identify objects</p>
                    </div>
                    <div class="toggle active" onclick="toggleSetting(this, 'autoDetect')"></div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>üîî Smart Reminders</h3>
                        <p>Get contextual notifications</p>
                    </div>
                    <div class="toggle active" onclick="toggleSetting(this, 'notifications')"></div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>üìç Location Tracking</h3>
                        <p>Track your location for context</p>
                    </div>
                    <div class="toggle active" onclick="toggleSetting(this, 'location')"></div>
                </div>
                
                <div style="margin-top: 32px;">
                    <button class="action-btn secondary" style="width: 100%; margin-bottom: 12px;" onclick="exportData()">
                        üíæ Export Data
                    </button>
                    <button class="action-btn" style="width: 100%; background: #ef4444;" onclick="clearAllData()">
                        üóëÔ∏è Clear All Memories
                    </button>
                </div>
                
                <div style="margin-top: 32px; text-align: center; color: #666; font-size: 12px;">
                    <p>AI Spatial Memory v1.0</p>
                    <p>Privacy-first personal memory assistant</p>
                    <div class="sync-status" id="syncStatus">Last sync: Never</div>
                </div>
            </div>
        </div>
        
        <!-- Floating Camera Button -->
        <button class="floating-camera" id="cameraBtn" onclick="openCamera()">
            üì∑
        </button>
        
        <!-- Camera View -->
        <div class="camera-preview" id="cameraView">
            <div class="camera-header">
                <h3>Tag Item Location</h3>
                <p style="color: #888; font-size: 14px; margin-top: 4px;">Point camera at item to remember its location</p>
            </div>
            <div class="camera-view">
                <video id="cameraVideo" autoplay playsinline></video>
                <div class="camera-placeholder" id="cameraPlaceholder">
                    üì∑ Starting camera...<br>
                    <small style="color: #666;">Please allow camera access</small>
                </div>
            </div>
            <div class="camera-controls">
                <button class="camera-close" onclick="closeCamera()">Cancel</button>
                <button class="capture-btn" id="captureBtn" onclick="capturePhoto()"></button>
                <button class="camera-close" onclick="toggleFlash()" style="background: #1f2937;">üí°</button>
            </div>
        </div>
        
        <!-- Processing Overlay -->
        <div class="processing-overlay" id="processingOverlay">
            <div class="spinner"></div>
            <div class="processing-text" id="processingText">Processing image...</div>
        </div>
        
        <!-- Toast Notification -->
        <div class="toast" id="toast"></div>
    </div>

    <script>
        // Global App State
        class SpatialMemoryApp {
            constructor() {
                this.memories = [];
                this.locations = [];
                this.settings = {
                    localStorage: true,
                    autoDetect: true,
                    notifications: true,
                    location: true
                };
                this.cameraManager = new CameraManager();
                this.locationManager = new LocationManager();
                this.currentTab = 'memories';
                this.isOnline = navigator.onLine;
                this.deferredPrompt = null;
                
                this.init();
            }
            
            async init() {
                this.setupEventListeners();
                this.loadStoredData();
                this.updateTime();
                this.checkOnlineStatus();
                this.requestNotificationPermission();
                this.registerServiceWorker();
                
                if (this.settings.location) {
                    this.startLocationTracking();
                }
                
                setTimeout(() => {
                    this.maybeShowInstallPrompt();
                }, 10000);
                
                this.startPeriodicReminders();
            }
            
            setupEventListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateOnlineStatus();
                    this.showToast('üåê Back online');
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateOnlineStatus();
                    this.showToast('üì∂ Offline mode', 'error');
                });
                
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'c' && e.ctrlKey) {
                        e.preventDefault();
                        this.openCamera();
                    } else if (e.key === 'f' && e.ctrlKey) {
                        e.preventDefault();
                        document.getElementById('memorySearch').focus();
                    } else if (e.key === 'Escape') {
                        this.closeCamera();
                    }
                });
                
                let lastTouchEnd = 0;
                document.addEventListener('touchend', (event) => {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
                
                setInterval(() => this.updateTime(), 1000);
            }
            
            loadStoredData() {
                try {
                    const stored = localStorage.getItem('spatialMemoryData');
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.memories = data.memories || [];
                        this.locations = data.locations || [];
                        this.settings = { ...this.settings, ...data.settings };
                    }
                    this.updateMemoriesDisplay();
                    this.updateLocationsDisplay();
                    this.updateSettingsDisplay();
                } catch (error) {
                    console.error('Failed to load stored data:', error);
                }
            }
            
            saveData() {
                try {
                    const data = {
                        memories: this.memories,
                        locations: this.locations,
                        settings: this.settings,
                        lastSaved: new Date().toISOString()
                    };
                    localStorage.setItem('spatialMemoryData', JSON.stringify(data));
                    document.getElementById('syncStatus').textContent = `Last sync: ${new Date().toLocaleTimeString()}`;
                } catch (error) {
                    console.error('Failed to save data:', error);
                    this.showToast('‚ö†Ô∏è Failed to save data', 'error');
                }
            }
            
            updateTime() {
                const now = new Date();
                const time = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                });
                document.getElementById('statusTime').textContent = time;
            }
            
            updateOnlineStatus() {
                const indicator = document.getElementById('offlineIndicator');
                indicator.style.display = this.isOnline ? 'none' : 'inline-block';
            }
            
            checkOnlineStatus() {
                this.updateOnlineStatus();
            }
            
            async startLocationTracking() {
                try {
                    const location = await this.locationManager.getCurrentLocation();
                    this.updateCurrentLocation(location);
                    
                    this.locationManager.startWatching((position) => {
                        this.handleLocationUpdate(position);
                    });
                } catch (error) {
                    console.error('Location tracking failed:', error);
                    this.updateCurrentLocation({
                        name: 'Location unavailable',
                        accuracy: 'Enable location access'
                    });
                }
            }
            
            updateCurrentLocation(location) {
    const locationName = typeof location === 'string' ? location : 
                        location.name || location.formatted_address || 
                        'Current Location';
    
    document.getElementById('currentLocation').textContent = locationName;
    document.getElementById('locationAccuracy').textContent = 
        location.accuracy ? `Accuracy: ¬±${location.accuracy}m` : 'Tap to refresh';
    
    this.addLocationToHistory({
        name: locationName,
        coordinates: location.coordinates
    });
}
            
            addLocationToHistory(location) {
    if (!location || !location.name) return;
    
    const locationName = typeof location.name === 'string' ? location.name : 'Unknown location';
    
    const existing = this.locations.find(l => l.name === locationName);
    if (existing) {
        existing.visits++;
        existing.lastVisit = new Date().toISOString();
    } else {
        this.locations.unshift({
            id: Date.now(),
            name: locationName,
            coordinates: location.coordinates || null,
            visits: 1,
            lastVisit: new Date().toISOString(),
            firstVisit: new Date().toISOString()
        });
    }
    
    this.locations = this.locations.slice(0, 50);
    this.updateLocationsDisplay();
    this.saveData();
}
            
            handleLocationUpdate(position) {
                if (this.lastLocationUpdate && 
                    Date.now() - this.lastLocationUpdate < 30000) {
                    return;
                }
                
                this.lastLocationUpdate = Date.now();
                this.reverseGeocode(position.coords.latitude, position.coords.longitude);
            }
            
            async reverseGeocode(lat, lng) {
                try {
                    const response = await fetch('/api/geocode', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ lat, lng })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.updateCurrentLocation(data.location);
                    }
                } catch (error) {
                    console.error('Reverse geocoding failed:', error);
                }
            }
            
            // Tab Management
            showTab(tabName) {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                event.target.classList.add('active');
                
                document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
                
                this.currentTab = tabName;
            }
            
            // Camera Operations
            async openCamera() {
                document.getElementById('cameraView').classList.add('active');
                document.getElementById('captureBtn').disabled = true;
                
                document.getElementById('cameraVideo').style.display = 'none';
                document.getElementById('cameraPlaceholder').style.display = 'flex';
                document.getElementById('cameraPlaceholder').innerHTML = `
                    üì∑ Starting camera...<br>
                    <small style="color: #666;">Please allow camera access</small>
                `;
                
                const success = await this.cameraManager.startCamera();
                if (success) {
                    document.getElementById('captureBtn').disabled = false;
                }
            }
            
            closeCamera() {
                document.getElementById('cameraView').classList.remove('active');
                this.cameraManager.stopCamera();
            }
            
            async capturePhoto() {
                const imageData = this.cameraManager.capturePhoto();
                if (!imageData) {
                    this.showToast('‚ùå Failed to capture photo', 'error');
                    return;
                }
                
                this.closeCamera();
                this.showProcessing('üì∏ Photo captured! Processing with AI...');
                
                try {
                    const currentLocation = document.getElementById('currentLocation').textContent;
                    
                    if (this.isOnline && this.settings.autoDetect) {
                        const response = await fetch('/api/vision', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                image: imageData,
                                location: currentLocation
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            this.addAIMemory(result.objects, currentLocation, imageData);
                            this.showToast(`‚úÖ Found ${result.objects.length} items!`);
                        } else {
                            throw new Error('AI processing failed');
                        }
                    } else {
                        this.addManualMemory(currentLocation, imageData);
                    }
                } catch (error) {
                    console.error('Photo processing failed:', error);
                    this.addManualMemory(currentLocation, imageData);
                    this.showToast('‚ö†Ô∏è Using offline mode', 'error');
                } finally {
                    this.hideProcessing();
                }
            }
            
            addAIMemory(objects, location, image) {
    objects.forEach(obj => {
        const memory = {
            id: Date.now() + Math.random(),
            item: obj.name,
            location: typeof location === 'string' ? location : location.name || 'Unknown location',
            timestamp: new Date().toISOString(),
            confidence: obj.confidence,
            image: image,
            aiDetected: true,
            description: obj.description
        };
        this.memories.unshift(memory);
    });
    
    this.updateMemoriesDisplay();
    this.saveData();
}

addManualMemory(location, image) {
    const itemName = prompt('üè∑Ô∏è What item did you photograph?');
    if (!itemName) return;
    
    const memory = {
        id: Date.now(),
        item: itemName,
        location: typeof location === 'string' ? location : location.name || 'Unknown location',
        timestamp: new Date().toISOString(),
        confidence: 90,
        image: image,
        aiDetected: false,
        userEntered: true
    };
    
    this.memories.unshift(memory);
    this.updateMemoriesDisplay();
    this.saveData();
    this.showToast(`‚úÖ Tagged "${itemName}"`);
}
                        
            // Memory Management
            updateMemoriesDisplay() {
                const memoriesList = document.getElementById('memoriesList');
                const memoryCount = document.getElementById('memoryCount');
                
                if (this.memories.length === 0) {
                    memoriesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üß†</div>
                            <p>No memories yet</p>
                            <p style="font-size: 14px; color: #888; margin-top: 8px;">
                                Tap the camera button to start tagging items
                            </p>
                        </div>
                    `;
                    memoryCount.textContent = '0';
                    return;
                }
                
                memoriesList.innerHTML = '';
                memoryCount.textContent = this.memories.length;
                
                this.memories.forEach(memory => {
                    const memoryCard = this.createMemoryCard(memory);
                    memoriesList.appendChild(memoryCard);
                });
            }
            
            createMemoryCard(memory) {
    const confidenceClass = memory.confidence >= 90 ? '' : 
                       memory.confidence >= 75 ? 'medium' : 'low';
    
    const timeAgo = this.getTimeAgo(memory.timestamp);
    
    const card = document.createElement('div');
    card.className = 'memory-card';
    card.setAttribute('data-item', memory.item.toLowerCase());
    
    // Ensure location is a string
    const locationText = typeof memory.location === 'string' ? memory.location : 'Unknown location';
    
    card.innerHTML = `
        <div class="confidence-badge ${confidenceClass}">${memory.confidence}% sure</div>
        <div style="display: flex; align-items: center;">
            ${memory.image ? `<img src="${memory.image}" class="memory-image" alt="${memory.item}">` : ''}
            <div class="memory-content">
                <div class="memory-item">
                    ${memory.item}
                    ${memory.aiDetected ? '<span class="ai-detected">AI</span>' : ''}
                </div>
                <div class="memory-location">üìç ${locationText}</div>
                <div class="memory-time">‚è∞ ${timeAgo}</div>
                ${memory.description ? `<div style="font-size: 12px; color: #888; margin-top: 4px;">${memory.description}</div>` : ''}
            </div>
        </div>
    `;
    
    card.onclick = () => this.showMemoryDetails(memory);
    return card;
}
            
            getTimeAgo(timestamp) {
                const now = new Date();
                const time = new Date(timestamp);
                const diffMs = now - time;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins} mins ago`;
                if (diffHours < 24) return `${diffHours} hours ago`;
                if (diffDays < 7) return `${diffDays} days ago`;
                return time.toLocaleDateString();
            }
            
            showMemoryDetails(memory) {
    const timeAgo = this.getTimeAgo(memory.timestamp);
    const locationText = typeof memory.location === 'string' ? memory.location : 'Unknown location';
    
    // Create custom overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        z-index: 3000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    `;
    
    // Create dialog
    const dialog = document.createElement('div');
    dialog.style.cssText = `
        background: #2a2a2a;
        border-radius: 12px;
        padding: 24px;
        max-width: 90vw;
        width: 400px;
        color: white;
        text-align: center;
    `;
    
    dialog.innerHTML = `
        <h3 style="margin-bottom: 16px; color: #3b82f6;">üìç ${memory.item}</h3>
        <div style="text-align: left; margin-bottom: 20px; line-height: 1.6;">
            <p><strong>Location:</strong> ${locationText}</p>
            <p><strong>Time:</strong> ${timeAgo}</p>
            <p><strong>Confidence:</strong> ${memory.confidence}%</p>
            ${memory.description ? `<p><strong>Description:</strong> ${memory.description}</p>` : ''}
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <button id="markFoundBtn" style="
                background: #22c55e;
                color: white;
                border: none;
                padding: 12px;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
            ">‚úÖ Mark Found</button>
            <button id="getDirectionsBtn" style="
                background: #3b82f6;
                color: white;
                border: none;
                padding: 12px;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
            ">üó∫Ô∏è Get Directions</button>
        </div>
        <button id="closeBtn" style="
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            margin-top: 12px;
            cursor: pointer;
            width: 100%;
        ">Close</button>
    `;
    
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    
    // Add event listeners
    document.getElementById('markFoundBtn').onclick = () => {
        this.markAsFound(memory);
        document.body.removeChild(overlay);
    };
    
    document.getElementById('getDirectionsBtn').onclick = () => {
        this.navigateToLocation(locationText);
        document.body.removeChild(overlay);
    };
    
    document.getElementById('closeBtn').onclick = () => {
        document.body.removeChild(overlay);
    };
    
    // Close on overlay click
    overlay.onclick = (e) => {
        if (e.target === overlay) {
            document.body.removeChild(overlay);
        }
    };
}

markAsFound(memory) {
    const index = this.memories.findIndex(m => m.id === memory.id);
    if (index > -1) {
        this.memories[index].found = true;
        this.memories[index].foundAt = new Date().toISOString();
        this.updateMemoriesDisplay();
        this.saveData();
        
        const itemName = memory.item || 'item';
        this.showToast(`‚úÖ Marked "${itemName}" as found`);
    }
}

navigateToLocation(locationName) {
    if (!locationName || locationName === 'Unknown location') {
        this.showToast('‚ùå Location not available for navigation', 'error');
        return;
    }
    
    // Find location with coordinates
    const location = this.locations.find(l => l.name === locationName);
    if (location && location.coordinates) {
        const { lat, lng } = location.coordinates;
        const url = `https://maps.google.com/maps?q=${lat},${lng}`;
        window.open(url, '_blank');
        this.showToast(`üó∫Ô∏è Opening directions to ${locationName}`);
    } else {
        // Fallback to search
        const url = `https://maps.google.com/maps?q=${encodeURIComponent(locationName)}`;
        window.open(url, '_blank');
        this.showToast(`üó∫Ô∏è Searching for ${locationName} on maps`);
    }
}
            
            markAsFound(memory) {
                const index = this.memories.findIndex(m => m.id === memory.id);
                if (index > -1) {
                    this.memories[index].found = true;
                    this.memories[index].foundAt = new Date().toISOString();
                    this.updateMemoriesDisplay();
                    this.saveData();
                    this.showToast(`‚úÖ Marked "${memory.item}" as found`);
                }
            }
            
            // Search and Find
            searchMemories() {
                const query = document.getElementById('memorySearch').value.toLowerCase();
                const memoryCards = document.querySelectorAll('#memoriesList .memory-card');
                
                memoryCards.forEach(card => {
                    const item = card.getAttribute('data-item');
                    if (item && item.includes(query)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }
            
            findItem() {
                const item = prompt('üîç What are you looking for?');
                if (!item) return;
                
                const foundMemory = this.memories.find(m => 
                    m.item.toLowerCase().includes(item.toLowerCase()) && !m.found
                );
                
                if (foundMemory) {
                    const timeAgo = this.getTimeAgo(foundMemory.timestamp);
                    this.showToast(`üìç Found: ${foundMemory.item} at ${foundMemory.location}`);
                    
                    setTimeout(() => {
                        if (confirm(`üéØ ${foundMemory.item}\n\nüìç Last seen: ${foundMemory.location}\n‚è∞ ${timeAgo}\nüéØ Confidence: ${foundMemory.confidence}%\n\nüö∂‚Äç‚ôÇÔ∏è Navigate there?`)) {
                            this.navigateToLocation(foundMemory.location);
                        }
                    }, 1500);
                } else {
                    this.showToast(`‚ùå "${item}" not found in memories`);
                    setTimeout(() => {
                        if (confirm(`ü§î Can't find "${item}". Want to tag it now?`)) {
                            this.openCamera();
                        }
                    }, 1500);
                }
            }
            
            navigateToLocation(locationName) {
                const location = this.locations.find(l => l.name === locationName);
                if (location && location.coordinates) {
                    const { lat, lng } = location.coordinates;
                    const url = `https://maps.google.com/maps?q=${lat},${lng}`;
                    window.open(url, '_blank');
                } else {
                    const url = `https://maps.google.com/maps?q=${encodeURIComponent(locationName)}`;
                    window.open(url, '_blank');
                }
                this.showToast(`üó∫Ô∏è Opening directions to ${locationName}`);
            }
            
            // Location Management
            refreshLocation() {
                document.getElementById('refreshLocationBtn').style.transform = 'rotate(360deg)';
                document.getElementById('currentLocation').textContent = 'Updating...';
                
                setTimeout(() => {
                    document.getElementById('refreshLocationBtn').style.transform = 'rotate(0deg)';
                }, 500);
                
                this.startLocationTracking();
            }
            
            updateLocationsDisplay() {
                const locationsList = document.getElementById('locationsList');
                
                if (this.locations.length === 0) {
                    locationsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìç</div>
                            <p>No locations tracked yet</p>
                            <p style="font-size: 14px; color: #888; margin-top: 8px;">
                                Locations will appear as you use the app
                            </p>
                        </div>
                    `;
                    return;
                }
                
                locationsList.innerHTML = '';
                
                const sortedLocations = [...this.locations].sort((a, b) => b.visits - a.visits);
                
                sortedLocations.forEach(location => {
                    const lastVisit = this.getTimeAgo(location.lastVisit);
                    const locationItem = document.createElement('div');
                    locationItem.className = 'location-item';
                    
                    locationItem.innerHTML = `
                        <div class="location-details">
                            <h3>üìç ${location.name}</h3>
                            <p>Last visit: ${lastVisit}</p>
                        </div>
                        <div class="location-stats">
                            <div class="location-visits">${location.visits} visits</div>
                            <div>Total</div>
                        </div>
                    `;
                    
                    locationItem.onclick = () => this.navigateToLocation(location.name);
                    locationsList.appendChild(locationItem);
                });
            }
            
            // Settings Management
            updateSettingsDisplay() {
                Object.keys(this.settings).forEach(setting => {
                    const toggle = document.querySelector(`[onclick*="${setting}"]`);
                    if (toggle) {
                        toggle.classList.toggle('active', this.settings[setting]);
                    }
                });
            }
            
            toggleSetting(element, setting) {
                element.classList.toggle('active');
                this.settings[setting] = element.classList.contains('active');
                
                const settingName = element.previousElementSibling.querySelector('h3').textContent;
                const isActive = this.settings[setting];
                
                this.showToast(`${isActive ? '‚úÖ' : '‚ùå'} ${settingName} ${isActive ? 'enabled' : 'disabled'}`);
                
                if (setting === 'location') {
                    if (isActive) {
                        this.startLocationTracking();
                    } else {
                        this.locationManager.stopWatching();
                    }
                } else if (setting === 'notifications') {
                    if (isActive) {
                        this.requestNotificationPermission();
                    }
                }
                
                this.saveData();
            }
            
            exportData() {
                const data = {
                    memories: this.memories,
                    locations: this.locations,
                    settings: this.settings,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `spatial-memory-export-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                this.showToast('üíæ Data exported successfully!');
            }
            
            clearAllData() {
                if (confirm('‚ö†Ô∏è This will delete all your memories and locations. Are you sure?')) {
                    if (confirm('üö® Last chance! This cannot be undone.')) {
                        this.memories = [];
                        this.locations = [];
                        localStorage.removeItem('spatialMemoryData');
                        
                        this.updateMemoriesDisplay();
                        this.updateLocationsDisplay();
                        this.showToast('üóëÔ∏è All data cleared');
                    }
                }
            }
            
            // Notifications and Prompts
            async requestNotificationPermission() {
    if ('Notification' in window) {
        if (Notification.permission === 'default') {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                this.showToast('üîî Notifications enabled');
                this.sendWelcomeNotification();
                // Start showing prompts more frequently
                this.startSmartPrompts();
            } else {
                this.showToast('‚ùå Notifications blocked', 'error');
            }
        } else if (Notification.permission === 'granted') {
            this.startSmartPrompts();
        }
    } else {
    if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
        this.showToast('üí° iPhone: Smart prompts will show when you open the app', 'info');
    } else {
        this.showToast('‚ùå Notifications not supported', 'error');
    }
}

startSmartPrompts() {
    // Only show prompts based on real user data
    // Don't show fake welcome prompts
    console.log('Smart prompts enabled - will only show based on real memories');
}
            
            sendWelcomeNotification() {
                if (Notification.permission === 'granted') {
                    new Notification('AI Spatial Memory Active', {
                        body: 'Your personal memory assistant is now running!',
                        icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxOTIgMTkyIj4KICA8cmVjdCB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgZmlsbD0iIzAwMDAwMCIvPgogIDxjaXJjbGUgY3g9Ijk2IiBjeT0iOTYiIHI9IjI4IiBmaWxsPSIjM0I4MkY2Ii8+CiAgPGNpcmNsZSBjeD0iOTYiIGN5PSIxNTYiIHI9IjEyIiBmaWxsPSIjM0I4MkY2Ii8+Cjwvc3ZnPg==',
                        tag: 'welcome'
                    });
                }
            }
            
            startPeriodicReminders() {
    // Only check for actual forgotten items every 5 minutes
    setInterval(() => {
        this.checkForForgottenItems();
    }, 300000); // Every 5 minutes
}
            
            checkForForgottenItems() {
                const currentLocation = document.getElementById('currentLocation').textContent;
                
                const forgottenItems = this.memories.filter(memory => 
                    memory.location !== currentLocation && 
                    !memory.found &&
                    Date.now() - new Date(memory.timestamp).getTime() > 3600000
                );
                
                if (forgottenItems.length > 0 && Math.random() > 0.7) {
                    const item = forgottenItems[0];
                    this.showSmartPrompt(`You left your ${item.item} at ${item.location}. Still there?`);
                }
            }
            
            showSmartPrompt(customMessage) {
    // Only show prompts based on actual user data
    if (this.memories.length === 0) {
        return; // Don't show prompts if no memories exist
    }
    
    // Create prompts based on actual memories
    const actualPrompts = [];
    
    // Check for items left in different locations
    const currentLocation = document.getElementById('currentLocation').textContent;
    const itemsElsewhere = this.memories.filter(memory => 
        memory.location !== currentLocation && !memory.found
    );
    
    if (itemsElsewhere.length > 0) {
        const item = itemsElsewhere[0];
        actualPrompts.push(`You left your ${item.item} at ${item.location}. Still need it?`);
    }
    
    // Only show prompt if we have real data or custom message
    const message = customMessage || (actualPrompts.length > 0 ? actualPrompts[0] : null);
    
    if (message) {
        document.getElementById('promptText').textContent = message;
        document.getElementById('smartPrompt').style.display = 'block';
    }
}
            
            dismissPrompt() {
                document.getElementById('smartPrompt').style.display = 'none';
                
                setTimeout(() => {
                    if (Math.random() > 0.6) {
                        this.showSmartPrompt();
                    }
                }, 30000 + Math.random() * 30000);
            }
            
            addToList() {
                this.showToast('‚úÖ Added to your shopping list!');
                this.dismissPrompt();
            }
            
            // PWA Installation
            maybeShowInstallPrompt() {
                if (this.deferredPrompt && !localStorage.getItem('installPromptDismissed')) {
                    document.getElementById('installBanner').style.display = 'block';
                }
            }
            
            async installApp() {
                if (this.deferredPrompt) {
                    this.deferredPrompt.prompt();
                    const result = await this.deferredPrompt.userChoice;
                    
                    if (result.outcome === 'accepted') {
                        this.showToast('üì± App installed successfully!');
                    }
                    
                    this.deferredPrompt = null;
                } else {
                    if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                        alert('üì± To install:\n1. Tap the Share button ‚¨ÜÔ∏è\n2. Tap "Add to Home Screen"\n3. Tap "Add"');
                    } else {
                        alert('üì± To install:\n1. Tap the menu (‚ãÆ)\n2. Tap "Add to Home screen"\n3. Tap "Add"');
                    }
                }
                
                this.dismissInstall();
            }
            
            dismissInstall() {
                document.getElementById('installBanner').style.display = 'none';
                localStorage.setItem('installPromptDismissed', 'true');
            }
            
            // Service Worker
            async registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        await navigator.serviceWorker.register('/sw.js');
                        console.log('Service Worker registered');
                    } catch (error) {
                        console.error('Service Worker registration failed:', error);
                    }
                }
            }
            
            // UI Helpers
            showProcessing(message) {
                document.getElementById('processingText').textContent = message;
                document.getElementById('processingOverlay').classList.add('active');
            }
            
            hideProcessing() {
                document.getElementById('processingOverlay').classList.remove('active');
            }
            
            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        }
        
        // Camera Manager
        class CameraManager {
            constructor() {
                this.stream = null;
                this.video = null;
                this.canvas = null;
            }
            
            async startCamera() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    
                    this.video = document.getElementById('cameraVideo');
                    this.video.srcObject = this.stream;
                    
                    await this.video.play();
                    
                    document.getElementById('cameraPlaceholder').style.display = 'none';
                    this.video.style.display = 'block';
                    
                    return true;
                } catch (error) {
                    console.error('Camera access failed:', error);
                    document.getElementById('cameraPlaceholder').innerHTML = `
                        ‚ùå Camera access denied<br>
                        <small style="color: #666;">Please enable camera access and refresh</small>
                    `;
                    return false;
                }
            }
            
            capturePhoto() {
                if (!this.video || this.video.videoWidth === 0) {
                    return null;
                }
                
                this.canvas = document.createElement('canvas');
                this.canvas.width = this.video.videoWidth;
                this.canvas.height = this.video.videoHeight;
                
                const ctx = this.canvas.getContext('2d');
                ctx.drawImage(this.video, 0, 0);
                
                return this.canvas.toDataURL('image/jpeg', 0.8);
            }
            
            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                if (this.video) {
                    this.video.srcObject = null;
                    this.video.style.display = 'none';
                    document.getElementById('cameraPlaceholder').style.display = 'flex';
                }
                    }
        }
        
        // Location Manager  
        class LocationManager {
            constructor() {
                this.watchId = null;
                this.currentPosition = null;
            }
            
            async getCurrentLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation not supported'));
                        return;
                    }
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            this.currentPosition = position;
                            resolve({
                                name: `${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`,
                                coordinates: {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude
                                },
                                accuracy: Math.round(position.coords.accuracy)
                            });
                        },
                        (error) => {
                            reject(error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000
                        }
                    );
                });
            }
            
            startWatching(callback) {
                if (!navigator.geolocation) return;
                
                this.watchId = navigator.geolocation.watchPosition(
                    callback,
                    (error) => console.error('Location watch error:', error),
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 60000
                    }
                );
            }
            
            stopWatching() {
                if (this.watchId) {
                    navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                }
            }
        }
        
        // Initialize app
        const app = new SpatialMemoryApp();
        
        // Global functions for HTML event handlers
        window.showTab = (tabName) => app.showTab(tabName);
        window.openCamera = () => app.openCamera();
        window.closeCamera = () => app.closeCamera();
        window.capturePhoto = () => app.capturePhoto();
        window.quickTag = () => app.openCamera();
        window.findItem = () => app.findItem();
        window.refreshLocation = () => app.refreshLocation();
        window.searchMemories = () => app.searchMemories();
        window.toggleSetting = (element, setting) => app.toggleSetting(element, setting);
        window.exportData = () => app.exportData();
        window.clearAllData = () => app.clearAllData();
        window.dismissPrompt = () => app.dismissPrompt();
        window.addToList = () => app.addToList();
        window.installApp = () => app.installApp();
        window.dismissInstall = () => app.dismissInstall();
        window.toggleFlash = () => app.toggleFlash();
        
        console.log('üöÄ AI Spatial Memory Production App loaded!');
        console.log('üí° Features ready:');
        console.log('   üì∑ Real camera integration');
        console.log('   üß† AI object detection');
        console.log('   üìç GPS location tracking');
        console.log('   üîî Smart notifications');
        console.log('   üì± PWA installation');
        console.log('   üîí Privacy-first design');
    </script>
</body>
</html>
